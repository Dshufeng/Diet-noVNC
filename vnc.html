<html>

<!-- 
noVNC Example: Automatically connect on page load.
Copyright (C) 2010 Joel Martin
Licensed under LGPL-3 (see LICENSE.txt)

Connect parameters are provided in query string:
    http://example.com/?host=HOST&port=PORT&encrypt=1
-->
<head>
    <title>VNC Client</title>
    <script src="include/util.js"></script>
    <script src="include/des.js"></script>
    <script src="include/canvas.js"></script>
    <script src="include/rfb.js"></script>

    <style>
        body { margin: 10; }
        #controls { overflow: hidden; }
        #controls ul { list-style: none; margin: 0; padding: 0; }
        #controls li { float: left; margin-right: 15px; }
        #controls input { width: 80px; }
        #screen  { display: table; }
        #top_bar { margin-top: 5; }
        .sNormal { background: #eee; }
        .sError  { background: #f44; }
        .sWarn   { background: #ff4; }
    </style>
</head>

<body>
    <div id="controls"> <ul>
        <li>Host: <input id="host"></li>
        <li>Port: <input id="port"></li>
        <li>Password: <input id="passwd" type="password"></li>
        <li><input id="cBtn" type="button" value="Loading" disabled></li>
    </ul> </div>

    <div id="screen">
        <div id="top_bar" class="top_bar">
            <table border=0 width="100%"><tr>
                <td><div id="status">Loading</div></td>
                <td width="1%">
                    <input id="cadBtn" type=button value="Send CtrlAltDel">
                </td>
            </tr></table>
        </div>
        <canvas id="vnc" width="640px" height="20px">
            Canvas not supported.
        </canvas>
    </div>

    <script>
    /*jslint white: false */
    /*global window, $, Util, RFB, */
    "use strict";

    var rfb;

    // Read a query string variable
    function getQueryVar(name, defVal) {
        var re = new RegExp('[?][^#]*' + name + '=([^&#]*)');
        if (typeof defVal === 'undefined') { defVal = null; }
        return (document.location.href.match(re) || ['',defVal])[1];
    };

    // Simple DOM selector by ID
    $ = function (id) {
        return document.getElementById ? document.getElementById(id) :
               document.all ? document.all[id] :
               document.layers ? document.layers[id] : undefined;
    };

    function connect() {
        rfb.connect($('host').value, $('port').value, $('passwd').value);
    };
    function setPassword() {
        rfb.sendPassword($('new_passwd').value);
        return false;
    }
    function sendCtrlAltDel() {
        rfb.sendCtrlAltDel();
        return false;
    }
    function updateState(rfb, state, oldstate, msg) {
        var s = $('status'), c = $('cBtn'), klass;
        $('cadBtn').disabled = true;
        c.disabled = false;
        c.value = "Connect";
        c.onclick = connect;
        if (state in {'normal':1, 'password':1}) {
            c.value = "Disconnect";
            c.onclick = rfb.disconnect;
        } else if (state in {'fatal':1, 'failed':1}) {
            c.disabled = true;
        }
        if (state === 'password') {
            msg = '<form onsubmit="return setPassword();"';
            msg += '  style="margin-bottom: 0px">';
            msg += 'Password Required: ';
            msg += '<input type=password size=10 id="new_passwd" class="status">';
            msg += '<\/form>';
        }
        switch (state) {
            case 'failed':       klass = "sError";  break;
            case 'fatal':        klass = "sError";  break;
            case 'normal':       $('cadBtn').disabled = false;
                                 klass = "sNormal"; break;
            case 'disconnected': klass = "sNormal"; break;
            case 'loaded':       klass = "sNormal"; break;
            default:             klass = "sWarn";
        }

        if (typeof(msg) !== 'undefined') {
            $('top_bar').setAttribute("class", klass);
            s.innerHTML = msg;
        }
    }

    window.onload = function () {
        $('cadBtn').onclick = sendCtrlAltDel;

        $('host').value = getQueryVar('host', null);
        $('port').value = getQueryVar('port', null);
        $('passwd').value = getQueryVar('password', '');

        rfb = new RFB({'target':      $('vnc'),
                       'encrypt':     getQueryVar('encrypt', false),
                       'updateState': updateState});
    }
    </script>

</body>

</html>
